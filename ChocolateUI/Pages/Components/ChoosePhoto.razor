@using ChocolateUI.Services
@inject ILogger<ChoosePhoto> Logger;
@inject IFetchService FetchService

<div class="form-control">
    @if (IsMultiple)
    {
        <InputFile id="images" OnChange="LoadFile"  multiple 
                   accept="image/jpeg, image/png" class="visually-hidden"/>
    }
    else
    {
        <InputFile id="images" OnChange="LoadFile"
                   accept="image/jpeg, image/png" class="visually-hidden"/>
    }
    <label class="btn btn-primary col-12" for="images">Выбирите файлы изображений</label>
</div>
<div class="container">
    <div class="row">
        @if (string.IsNullOrWhiteSpace(ImageData))
        {
            <img src="@CurrentImage" alt="" class="col-12" style="padding: 0"/>
        }
        else
        {
            <img src="data:image/png;base64,@ImageData" alt="" class="col-12" style="padding: 0"/>
        }
    </div>
</div>

@code 
{
    [Parameter]
    public bool IsMultiple { get; set; }

    private string _imageData = "";
    public string ImageData
    {
        get => _imageData;
        set
        {
            _imageData = value;
            StateHasChanged();
        }
    }
    
    private string _currentImage = "";

    public string CurrentImage
    {
        get => _currentImage;
        set
        {
            Logger.LogInformation("_currentImage = {CurrentImage}", _currentImage);
            _currentImage = value;
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        CurrentImage = $"{FetchService.BaseUrl}images/NoImage.png";
        base.OnInitialized();
    }

    private async Task LoadFile(InputFileChangeEventArgs e)
    {
        try
        {
            await using var stream = e.File.OpenReadStream(e.File.Size);
            var croppedPhoto = await FetchService.CropPhoto(stream);
            ImageData = croppedPhoto;
            Logger.LogInformation("Cropped photo loaded");
        }
        catch (Exception exception)
        {
            Logger.LogError(exception, "Ошибка загрузки файла изображения");
            throw;
        }
    }

    public string GetImageBase64()
    {
        return ImageData;
    }

    public void ClearImage()
    {
        ImageData = "";
    }

    public void Show()
    {
        StateHasChanged();
    }
}